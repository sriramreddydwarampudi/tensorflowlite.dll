name: Build TFLite AAR and DLL

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  # -------------------------------------------
  #  ANDROID AAR BUILD (Linux + Bazel)
  # -------------------------------------------
  build-aar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y python3 zip unzip build-essential

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Install Android NDK and Build Tools
        run: |
          yes | sdkmanager --licenses || true
          sdkmanager --install "ndk;25.2.9519653"
          sdkmanager --install "build-tools;34.0.0"
          sdkmanager --install "platforms;android-34"
          echo "ANDROID_HOME=$ANDROID_HOME"
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653"

      - name: Install Bazelisk
        run: |
          sudo wget https://github.com/bazelbuild/bazelisk/releases/latest/download/bazelisk-linux-amd64 -O /usr/local/bin/bazel
          sudo chmod +x /usr/local/bin/bazel

      - name: Clone TensorFlow
        run: git clone --depth 1 --branch v2.18.0 https://github.com/tensorflow/tensorflow.git

      - name: Register Android SDK with Bazel
        run: |
          cd tensorflow
          
          # Create WORKSPACE.user to register Android SDK
          cat > WORKSPACE.user << EOF
          android_sdk_repository(
              name = "androidsdk",
              api_level = 34,
              build_tools_version = "34.0.0",
              path = "$ANDROID_HOME",
          )

          android_ndk_repository(
              name = "androidndk",
              api_level = 21,
              path = "$ANDROID_HOME/ndk/25.2.9519653",
          )
          EOF
          
          cat WORKSPACE.user

      - name: Build TFLite AAR with registered SDK
        run: |
          cd tensorflow
          bazel build \
            --config=android_arm64 \
            -c opt \
            //tensorflow/lite/java:tensorflow-lite
        env:
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          ANDROID_NDK_HOME: ${{ env.ANDROID_HOME }}/ndk/25.2.9519653

      - name: Build for multiple architectures
        if: success()
        run: |
          cd tensorflow
          bazel build \
            --config=android \
            --fat_apk_cpu=armeabi-v7a,arm64-v8a,x86,x86_64 \
            -c opt \
            //tensorflow/lite/java:tensorflow-lite
        continue-on-error: true

      - name: List built files
        if: always()
        run: |
          echo "Searching for built artifacts..."
          find tensorflow/bazel-bin/tensorflow/lite -name "*.aar" -o -name "*.jar" -o -name "*.so" || true

      - name: Upload AAR Files
        uses: actions/upload-artifact@v4
        with:
          name: tflite-aar
          path: |
            tensorflow/bazel-bin/tensorflow/lite/java/*.aar
            tensorflow/bazel-bin/tensorflow/lite/java/*.jar
        if: always()


  # -------------------------------------------
  #  WINDOWS DLL BUILD (MSVC + CMake)
  # -------------------------------------------
  build-dll:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install CMake and Ninja
        run: |
          choco install cmake -y
          choco install ninja -y

      - name: Clone TensorFlow
        run: git clone --depth 1 --branch v2.18.0 https://github.com/tensorflow/tensorflow.git

      - name: Create build directory
        run: mkdir tensorflow\tensorflow\lite\build

      - name: Configure with CMake
        run: |
          cd tensorflow\tensorflow\lite\build
          cmake .. `
            -G "Ninja" `
            -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_SHARED_LIBS=ON `
            -DTFLITE_ENABLE_XNNPACK=ON `
            -DTFLITE_ENABLE_RUY=ON

      - name: Build TFLite
        run: |
          cd tensorflow\tensorflow\lite\build
          ninja tensorflowlite_c

      - name: Find and List Built Files
        shell: pwsh
        run: |
          Write-Host "Searching for built files..."
          Get-ChildItem -Path tensorflow\tensorflow\lite\build -Recurse -Include *.dll,*.lib,*.pdb | ForEach-Object { 
            Write-Host $_.FullName 
          }

      - name: Copy built files to output directory
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path output
          Get-ChildItem -Path tensorflow\tensorflow\lite\build -Recurse -Include *.dll,*.lib,*.pdb | Copy-Item -Destination output -Force

      - name: Upload DLL
        uses: actions/upload-artifact@v4
        with:
          name: tflite-windows-dll
          path: output/*
        if: always()
