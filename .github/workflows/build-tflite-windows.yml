name: Build TensorFlow Lite C DLL

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-tflite-c-dll:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Visual Studio
      uses: microsoft/setup-msbuild@v1
      
    - name: Install Tools
      shell: cmd
      run: |
        choco install cmake --installargs "ADD_CMAKE_TO_PATH=System" -y
        choco install ninja -y
        
    - name: Clean and Clone TensorFlow
      shell: cmd
      run: |
        if exist tensorflow rmdir /s /q tensorflow
        git clone https://github.com/tensorflow/tensorflow.git
        cd tensorflow
        git checkout v2.18.0
        
    - name: Initial CMake Configure (to download dependencies)
      shell: cmd
      continue-on-error: true
      run: |
        cd tensorflow\tensorflow\lite\c
        if exist build rmdir /s /q build
        mkdir build
        cd build
        cmake .. -G "Ninja" ^
          -DCMAKE_BUILD_TYPE=Release ^
          -DBUILD_SHARED_LIBS=ON ^
          -DTFLITE_ENABLE_GPU=OFF ^
          -DTFLITE_ENABLE_NNAPI=OFF ^
          -DTFLITE_ENABLE_XNNPACK=ON ^
          -DTFLITE_ENABLE_RUY=ON
    
    - name: Patch FP16 CMakeLists.txt
      shell: powershell
      run: |
        $fp16Path = "tensorflow\tensorflow\lite\c\FP16-source\CMakeLists.txt"
        if (Test-Path $fp16Path) {
          $content = Get-Content $fp16Path -Raw
          $content = $content -replace 'CMAKE_MINIMUM_REQUIRED\(VERSION 2\.8\.12 FATAL_ERROR\)', 'CMAKE_MINIMUM_REQUIRED(VERSION 3.5 FATAL_ERROR)'
          Set-Content $fp16Path -Value $content
          Write-Host "FP16 CMakeLists.txt patched successfully"
        } else {
          Write-Host "FP16 source not found, checking alternative locations..."
          Get-ChildItem -Path "tensorflow\tensorflow\lite\c" -Recurse -Filter "CMakeLists.txt" | Where-Object { $_.FullName -like "*FP16*" }
        }
        
    - name: Configure TFLite Build
      shell: cmd
      run: |
        cd tensorflow\tensorflow\lite\c\build
        cmake .. -G "Ninja" ^
          -DCMAKE_BUILD_TYPE=Release ^
          -DBUILD_SHARED_LIBS=ON ^
          -DTFLITE_ENABLE_GPU=OFF ^
          -DTFLITE_ENABLE_NNAPI=OFF ^
          -DTFLITE_ENABLE_XNNPACK=ON ^
          -DTFLITE_ENABLE_RUY=ON
        
    - name: Build TFLite C Library
      shell: cmd
      run: |
        cd tensorflow\tensorflow\lite\c\build
        cmake --build . --config Release
        
    - name: Collect Artifacts
      shell: cmd
      run: |
        mkdir output
        
        echo Looking for built files...
        
        rem Copy DLL and LIB files from build directory
        if exist tensorflow\tensorflow\lite\c\build\*.dll (
            copy tensorflow\tensorflow\lite\c\build\*.dll output\
        )
        if exist tensorflow\tensorflow\lite\c\build\*.lib (
            copy tensorflow\tensorflow\lite\c\build\*.lib output\
        )
        
        rem Check Release subdirectory
        if exist tensorflow\tensorflow\lite\c\build\Release\*.dll (
            copy tensorflow\tensorflow\lite\c\build\Release\*.dll output\
        )
        if exist tensorflow\tensorflow\lite\c\build\Release\*.lib (
            copy tensorflow\tensorflow\lite\c\build\Release\*.lib output\
        )
        
        rem Copy headers
        mkdir output\include
        xcopy /E /I tensorflow\tensorflow\lite\c\*.h output\include\
        
        rem Show output
        echo Output directory contents:
        dir output
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tflite-dll
        path: output/*
