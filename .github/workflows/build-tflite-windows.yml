name: Build TensorFlow Lite C DLL

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-tflite-c-dll:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Visual Studio
      uses: microsoft/setup-msbuild@v1
      
    - name: Install Tools
      run: |
        choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
        choco install ninja -y
        
    - name: Clone TensorFlow
      run: |
        git clone https://github.com/tensorflow/tensorflow.git
        cd tensorflow
        git checkout v2.18.0
        
    - name: Configure and Build
      run: |
        cd tensorflow
        
        # Configure
        cmake -S . -B build ^
          -G "Ninja" ^
          -DCMAKE_BUILD_TYPE=Release ^
          -DBUILD_SHARED_LIBS=ON ^
          -DTFLITE_ENABLE_GPU=OFF ^
          -DTFLITE_ENABLE_NNAPI=OFF ^
          -DTFLITE_BUILD_CC_LIB=ON ^
          -DTFLITE_BUILD_PYTHON_MODULE=OFF
        
        # Build
        cmake --build build --target tensorflowlite_c
        
    - name: Collect Artifacts
      shell: cmd
      run: |
        mkdir output
        copy tensorflow\build\*.dll output\ 2>nul || echo "No DLLs found"
        copy tensorflow\build\*.lib output\ 2>nul || echo "No LIBs found"
        dir output
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tflite-dll
        path: output/*
