name: Build TFLite AAR and DLL

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  # -------------------------------------------
  #  ANDROID AAR BUILD (Linux + Bazel)
  # -------------------------------------------
  build-aar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y python3 zip unzip build-essential openjdk-17-jdk

      - name: Install Bazelisk
        run: |
          sudo wget https://github.com/bazelbuild/bazelisk/releases/latest/download/bazelisk-linux-amd64 -O /usr/local/bin/bazel
          sudo chmod +x /usr/local/bin/bazel

      - name: Clone TensorFlow
        run: git clone --depth 1 https://github.com/tensorflow/tensorflow.git

      - name: Build TFLite AAR (CPU)
        run: |
          cd tensorflow
          bazel build -c opt //tensorflow/lite/java:tensorflow-lite

      - name: Build TFLite GPU AAR
        run: |
          cd tensorflow
          bazel build -c opt //tensorflow/lite/java:tensorflow-lite-gpu

      - name: Build Select TF Ops AAR
        run: |
          cd tensorflow
          bazel build -c opt //tensorflow/lite/java:tensorflow-lite-select-tf-ops

      - name: Upload AAR Files
        uses: actions/upload-artifact@v4
        with:
          name: tflite-aar
          path: tensorflow/bazel-bin/tensorflow/lite/java/*.aar


  # -------------------------------------------
  #  WINDOWS DLL BUILD (MinGW + CMake + Ninja)
  # -------------------------------------------
  build-dll:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          choco install ninja -y
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=1' -y
          choco install mingw -y

      - name: Clone TensorFlow
        run: git clone --depth 1 https://github.com/tensorflow/tensorflow.git

      - name: Create build directory
        run: mkdir tensorflow\tensorflow\lite\build

      - name: Configure with CMake
        run: |
          cd tensorflow/tensorflow/lite/build
          cmake .. ^
            -DCMAKE_SYSTEM_NAME=Windows ^
            -DCMAKE_C_COMPILER="C:/ProgramData/chocolatey/lib/mingw/tools/install/mingw64/bin/gcc.exe" ^
            -DCMAKE_CXX_COMPILER="C:/ProgramData/chocolatey/lib/mingw/tools/install/mingw64/bin/g++.exe" ^
            -DTFLITE_ENABLE_XNNPACK=ON ^
            -DTFLITE_ENABLE_C_API=ON ^
            -DCMAKE_BUILD_TYPE=Release ^
            -G Ninja

      - name: Build TFLite DLL
        run: |
          cd tensorflow/tensorflow/lite/build
          ninja

      - name: Upload DLL
        uses: actions/upload-artifact@v4
        with:
          name: tflite-windows-dll
          path: |
            tensorflow/tensorflow/lite/build/*.dll
            tensorflow/tensorflow/lite/build/*.lib
            tensorflow/tensorflow/lite/build/*.a
