name: Build TensorFlow Lite C DLL

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-tflite-c-dll:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Visual Studio
      uses: microsoft/setup-msbuild@v1
      
    - name: Install Tools
      run: |
        choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
        choco install ninja -y
        
    - name: Clone TensorFlow
      run: |
        rmdir /s /q tensorflow 2>nul || echo "No existing tensorflow directory"
        git clone https://github.com/tensorflow/tensorflow.git
        cd tensorflow
        git checkout v2.18.0
        
    - name: Configure TFLite Build
      run: |
        cd tensorflow\tensorflow\lite
        rmdir /s /q build 2>nul || echo "No existing build directory"
        mkdir build
        cd build
        cmake .. -G "Ninja" ^
          -DCMAKE_BUILD_TYPE=Release ^
          -DBUILD_SHARED_LIBS=ON ^
          -DTFLITE_ENABLE_GPU=OFF ^
          -DTFLITE_ENABLE_NNAPI=OFF ^
          -DTFLITE_ENABLE_XNNPACK=ON ^
          -DTFLITE_ENABLE_RUY=ON ^
          -DTFLITE_BUILD_CC_LIB=ON ^
          -DTFLITE_BUILD_PYTHON_MODULE=OFF
        
    - name: Build TFLite C Library
      run: |
        cd tensorflow\tensorflow\lite\build
        cmake --build . --target tensorflowlite_c
        
    - name: Collect Artifacts
      shell: cmd
      run: |
        mkdir output
        cd tensorflow\tensorflow\lite\build
        
        echo "Looking for built files..."
        dir
        
        rem Copy any DLL or LIB files
        copy *.dll ..\..\..\..\output\ 2>nul || echo "No DLLs found in root"
        copy *.lib ..\..\..\..\output\ 2>nul || echo "No LIBs found in root"
        
        rem Check Release directory
        if exist Release (
            cd Release
            copy *.dll ..\..\..\..\..\output\ 2>nul || echo "No DLLs in Release"
            copy *.lib ..\..\..\..\..\output\ 2>nul || echo "No LIBs in Release"
            cd ..
        )
        
        rem Copy headers
        mkdir ..\..\..\..\output\include
        xcopy /E /I ..\c ..\..\..\..\output\include
        
        rem Show what we collected
        cd ..\..\..\..\output
        echo "Output directory contents:"
        dir
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tflite-dll
        path: output/*
