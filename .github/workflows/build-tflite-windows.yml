name: Build TFLite AAR and DLL

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  # -------------------------------------------
  #  ANDROID AAR BUILD (Linux + Bazel)
  # -------------------------------------------
  build-aar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y python3 zip unzip build-essential

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Install Android NDK and Build Tools
        run: |
          yes | sdkmanager --licenses || true
          sdkmanager --install "ndk;25.2.9519653"
          sdkmanager --install "build-tools;34.0.0"
          sdkmanager --install "platforms;android-34"

      - name: Install Bazelisk
        run: |
          sudo wget https://github.com/bazelbuild/bazelisk/releases/latest/download/bazelisk-linux-amd64 -O /usr/local/bin/bazel
          sudo chmod +x /usr/local/bin/bazel

      - name: Clone TensorFlow
        run: git clone --depth 1 --branch v2.18.0 https://github.com/tensorflow/tensorflow.git

      - name: Configure Android SDK for Bazel
        run: |
          cd tensorflow
          
          # Create local.properties
          cat > local.properties << EOF
          sdk.dir=$ANDROID_HOME
          ndk.dir=$ANDROID_HOME/ndk/25.2.9519653
          EOF
          
          # Create .bazelrc.user with Android configuration
          cat > .bazelrc.user << EOF
          build --action_env ANDROID_HOME=$ANDROID_HOME
          build --action_env ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653
          build --repo_env=ANDROID_HOME=$ANDROID_HOME
          build --repo_env=ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653
          EOF
          
          # Verify Android SDK location
          echo "ANDROID_HOME is: $ANDROID_HOME"
          ls -la $ANDROID_HOME
          ls -la $ANDROID_HOME/ndk/

      - name: Configure TensorFlow
        run: |
          cd tensorflow
          # Use Python to run configure
          python3 << 'PYTHON_SCRIPT'
          import os
          
          # Set environment variables for configure
          os.environ['ANDROID_API_LEVEL'] = '34'
          os.environ['ANDROID_BUILD_TOOLS_VERSION'] = '34.0.0'
          os.environ['ANDROID_SDK_HOME'] = os.environ.get('ANDROID_HOME', '')
          os.environ['ANDROID_NDK_HOME'] = os.path.join(os.environ.get('ANDROID_HOME', ''), 'ndk/25.2.9519653')
          
          # Create a simple response file for configure
          with open('/tmp/configure_responses.txt', 'w') as f:
              f.write('\n' * 20)  # Answer no/default to most questions
          
          print(f"ANDROID_SDK_HOME: {os.environ['ANDROID_SDK_HOME']}")
          print(f"ANDROID_NDK_HOME: {os.environ['ANDROID_NDK_HOME']}")
          PYTHON_SCRIPT

      - name: Build TFLite AAR (CPU) with explicit Android SDK
        run: |
          cd tensorflow
          bazel build \
            --config=android_arm64 \
            --action_env ANDROID_HOME=$ANDROID_HOME \
            --action_env ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653 \
            --define=android_dexmerger_tool=d8_dexmerger \
            --define=android_incremental_dexing_tool=d8_dexbuilder \
            -c opt \
            //tensorflow/lite/java:tensorflow-lite

      - name: Try alternative build target
        if: failure()
        run: |
          cd tensorflow
          # Try building without Android-specific config
          bazel build -c opt //tensorflow/lite/c:tensorflowlite_c
        continue-on-error: true

      - name: List built files
        if: always()
        run: |
          echo "Searching for built artifacts..."
          find tensorflow/bazel-bin -name "*.aar" -o -name "*.jar" -o -name "*.so" || true

      - name: Upload AAR Files
        uses: actions/upload-artifact@v4
        with:
          name: tflite-aar
          path: |
            tensorflow/bazel-bin/tensorflow/lite/java/*.aar
            tensorflow/bazel-bin/tensorflow/lite/java/*.jar
            tensorflow/bazel-bin/tensorflow/lite/c/*.so
        if: always()


  # -------------------------------------------
  #  WINDOWS DLL BUILD (MSVC + CMake)
  # -------------------------------------------
  build-dll:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install CMake and Ninja
        run: |
          choco install cmake -y
          choco install ninja -y

      - name: Clone TensorFlow
        run: git clone --depth 1 --branch v2.18.0 https://github.com/tensorflow/tensorflow.git

      - name: Create build directory
        run: mkdir tensorflow\tensorflow\lite\build

      - name: Configure with CMake
        run: |
          cd tensorflow\tensorflow\lite\build
          cmake .. `
            -G "Ninja" `
            -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_SHARED_LIBS=ON `
            -DTFLITE_ENABLE_XNNPACK=ON `
            -DTFLITE_ENABLE_RUY=ON

      - name: Build TFLite
        run: |
          cd tensorflow\tensorflow\lite\build
          ninja tensorflowlite_c

      - name: Find and List Built Files
        shell: pwsh
        run: |
          Write-Host "Searching for built files..."
          Get-ChildItem -Path tensorflow\tensorflow\lite\build -Recurse -Include *.dll,*.lib,*.pdb | ForEach-Object { 
            Write-Host $_.FullName 
          }

      - name: Copy built files to output directory
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path output
          Get-ChildItem -Path tensorflow\tensorflow\lite\build -Recurse -Include *.dll,*.lib,*.pdb | Copy-Item -Destination output -Force

      - name: Upload DLL
        uses: actions/upload-artifact@v4
        with:
          name: tflite-windows-dll
          path: output/*
        if: always()
