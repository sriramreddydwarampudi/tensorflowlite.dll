name: Build TFLite AAR and DLL

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  # -------------------------------------------
  #  ANDROID AAR BUILD (Using build_aar.sh script)
  # -------------------------------------------
  build-aar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y python3 zip unzip build-essential

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Install Android NDK and Build Tools
        run: |
          yes | sdkmanager --licenses || true
          sdkmanager --install "ndk;25.2.9519653"
          sdkmanager --install "build-tools;34.0.0"
          sdkmanager --install "platforms;android-34"

      - name: Install Bazelisk
        run: |
          sudo wget https://github.com/bazelbuild/bazelisk/releases/latest/download/bazelisk-linux-amd64 -O /usr/local/bin/bazel
          sudo chmod +x /usr/local/bin/bazel

      - name: Clone TensorFlow
        run: git clone --depth 1 --branch v2.18.0 https://github.com/tensorflow/tensorflow.git

      - name: Configure TensorFlow
        run: |
          cd tensorflow
          export ANDROID_SDK_HOME=$ANDROID_HOME
          export ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653
          
          # Run configure with default settings
          python3 configure.py << EOF
          
          
          
          
          
          
          
          
          
          
          EOF
        env:
          ANDROID_HOME: ${{ env.ANDROID_HOME }}

      - name: Build TFLite AAR using official script
        run: |
          cd tensorflow
          export ANDROID_SDK_HOME=$ANDROID_HOME
          export ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653
          
          # Use TensorFlow's official build script
          bash tensorflow/lite/tools/build_aar.sh \
            --target_archs=x86,x86_64,arm64-v8a,armeabi-v7a
        env:
          ANDROID_HOME: ${{ env.ANDROID_HOME }}

      - name: Find built AAR files
        run: |
          find tensorflow -name "*.aar" -type f

      - name: Upload AAR Files
        uses: actions/upload-artifact@v4
        with:
          name: tflite-aar
          path: |
            tensorflow/**/*.aar
        if: always()


  # -------------------------------------------
  #  ANDROID AAR BUILD - Alternative CMake method
  # -------------------------------------------
  build-aar-cmake:
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y cmake ninja-build

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Install Android NDK
        run: |
          yes | sdkmanager --licenses || true
          sdkmanager --install "ndk;25.2.9519653"

      - name: Clone TensorFlow
        run: git clone --depth 1 --branch v2.18.0 https://github.com/tensorflow/tensorflow.git

      - name: Build TFLite with CMake for Android
        run: |
          cd tensorflow
          
          # Build for arm64-v8a
          mkdir -p build_android_arm64
          cd build_android_arm64
          
          cmake ../tensorflow/lite \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_HOME/ndk/25.2.9519653/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-21 \
            -DCMAKE_BUILD_TYPE=Release \
            -DTFLITE_ENABLE_XNNPACK=ON \
            -GNinja
          
          ninja
          
          cd ..
          
          # Build for armeabi-v7a
          mkdir -p build_android_armv7
          cd build_android_armv7
          
          cmake ../tensorflow/lite \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_HOME/ndk/25.2.9519653/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=armeabi-v7a \
            -DANDROID_PLATFORM=android-21 \
            -DCMAKE_BUILD_TYPE=Release \
            -DTFLITE_ENABLE_XNNPACK=ON \
            -GNinja
          
          ninja

      - name: List built files
        run: |
          find tensorflow/build_android_* -name "*.so" -o -name "*.a"

      - name: Upload Android Libraries
        uses: actions/upload-artifact@v4
        with:
          name: tflite-android-libs
          path: |
            tensorflow/build_android_arm64/**/*.so
            tensorflow/build_android_arm64/**/*.a
            tensorflow/build_android_armv7/**/*.so
            tensorflow/build_android_armv7/**/*.a
        if: always()


  # -------------------------------------------
  #  WINDOWS DLL BUILD (MSVC + CMake)
  # -------------------------------------------
  build-dll:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install CMake and Ninja
        run: |
          choco install cmake -y
          choco install ninja -y

      - name: Clone TensorFlow
        run: git clone --depth 1 --branch v2.18.0 https://github.com/tensorflow/tensorflow.git

      - name: Create build directory
        run: mkdir tensorflow\tensorflow\lite\build

      - name: Configure with CMake
        run: |
          cd tensorflow\tensorflow\lite\build
          cmake .. `
            -G "Ninja" `
            -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_SHARED_LIBS=ON `
            -DTFLITE_ENABLE_XNNPACK=ON `
            -DTFLITE_ENABLE_RUY=ON

      - name: Build TFLite
        run: |
          cd tensorflow\tensorflow\lite\build
          ninja tensorflowlite_c

      - name: Find and List Built Files
        shell: pwsh
        run: |
          Write-Host "Searching for built files..."
          Get-ChildItem -Path tensorflow\tensorflow\lite\build -Recurse -Include *.dll,*.lib,*.pdb | ForEach-Object { 
            Write-Host $_.FullName 
          }

      - name: Copy built files to output directory
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path output
          Get-ChildItem -Path tensorflow\tensorflow\lite\build -Recurse -Include *.dll,*.lib,*.pdb | Copy-Item -Destination output -Force

      - name: Upload DLL
        uses: actions/upload-artifact@v4
        with:
          name: tflite-windows-dll
          path: output/*
        if: always()
