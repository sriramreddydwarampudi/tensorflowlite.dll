name: Build TensorFlow Lite C DLL

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-tflite-c-dll:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Visual Studio
      uses: microsoft/setup-msbuild@v1
      
    - name: Install Tools
      shell: cmd
      run: |
        choco install cmake --installargs "ADD_CMAKE_TO_PATH=System" -y
        choco install ninja -y
        
    - name: Clean and Clone TensorFlow
      shell: cmd
      run: |
        if exist tensorflow rmdir /s /q tensorflow
        git clone https://github.com/tensorflow/tensorflow.git
        cd tensorflow
        git checkout v2.18.0
        
    - name: First CMake Configure (download initial dependencies)
      shell: cmd
      continue-on-error: true
      run: |
        cd tensorflow\tensorflow\lite\c
        if exist build rmdir /s /q build
        mkdir build
        cd build
        cmake .. -G "Ninja" ^
          -DCMAKE_BUILD_TYPE=Release ^
          -DBUILD_SHARED_LIBS=ON ^
          -DTFLITE_ENABLE_GPU=OFF ^
          -DTFLITE_ENABLE_NNAPI=OFF ^
          -DTFLITE_ENABLE_XNNPACK=ON ^
          -DTFLITE_ENABLE_RUY=ON
    
    - name: First Patch Pass
      shell: powershell
      run: |
        $cmakeFiles = Get-ChildItem -Path "tensorflow\tensorflow\lite\c" -Recurse -Filter "CMakeLists.txt"
        
        foreach ($file in $cmakeFiles) {
          $content = Get-Content $file.FullName -Raw
          $modified = $false
          
          if ($content -match 'CMAKE_MINIMUM_REQUIRED\s*\(\s*VERSION\s+2\.\d+') {
            $content = $content -replace 'CMAKE_MINIMUM_REQUIRED\s*\(\s*VERSION\s+2\.\d+\.\d+\s+FATAL_ERROR\s*\)', 'CMAKE_MINIMUM_REQUIRED(VERSION 3.5 FATAL_ERROR)'
            $content = $content -replace 'CMAKE_MINIMUM_REQUIRED\s*\(\s*VERSION\s+2\.\d+\.\d+\s*\)', 'CMAKE_MINIMUM_REQUIRED(VERSION 3.5)'
            $modified = $true
          }
          
          if ($modified) {
            Set-Content $file.FullName -Value $content
            Write-Host "Patched: $($file.FullName)"
          }
        }
        
    - name: Second CMake Configure (download remaining dependencies)
      shell: cmd
      continue-on-error: true
      run: |
        cd tensorflow\tensorflow\lite\c\build
        cmake .. -G "Ninja" ^
          -DCMAKE_BUILD_TYPE=Release ^
          -DBUILD_SHARED_LIBS=ON ^
          -DTFLITE_ENABLE_GPU=OFF ^
          -DTFLITE_ENABLE_NNAPI=OFF ^
          -DTFLITE_ENABLE_XNNPACK=ON ^
          -DTFLITE_ENABLE_RUY=ON
    
    - name: Second Patch Pass
      shell: powershell
      run: |
        $cmakeFiles = Get-ChildItem -Path "tensorflow\tensorflow\lite\c" -Recurse -Filter "CMakeLists.txt"
        
        foreach ($file in $cmakeFiles) {
          $content = Get-Content $file.FullName -Raw
          $modified = $false
          
          if ($content -match 'CMAKE_MINIMUM_REQUIRED\s*\(\s*VERSION\s+2\.\d+') {
            $content = $content -replace 'CMAKE_MINIMUM_REQUIRED\s*\(\s*VERSION\s+2\.\d+\.\d+\s+FATAL_ERROR\s*\)', 'CMAKE_MINIMUM_REQUIRED(VERSION 3.5 FATAL_ERROR)'
            $content = $content -replace 'CMAKE_MINIMUM_REQUIRED\s*\(\s*VERSION\s+2\.\d+\.\d+\s*\)', 'CMAKE_MINIMUM_REQUIRED(VERSION 3.5)'
            $modified = $true
          }
          
          if ($modified) {
            Set-Content $file.FullName -Value $content
            Write-Host "Patched: $($file.FullName)"
          }
        }
        
        Write-Host "All dependency patching complete"
        
    - name: Clean Build Directory
      shell: powershell
      run: |
        $buildPath = "tensorflow\tensorflow\lite\c\build"
        if (Test-Path $buildPath) {
          Remove-Item -Path $buildPath -Recurse -Force
          Write-Host "Removed existing build directory"
        }
        New-Item -Path $buildPath -ItemType Directory -Force | Out-Null
        Write-Host "Created fresh build directory"
        
    - name: Final CMake Configure
      shell: cmd
      run: |
        cd tensorflow\tensorflow\lite\c\build
        cmake .. -G "Ninja" ^
          -DCMAKE_BUILD_TYPE=Release ^
          -DBUILD_SHARED_LIBS=ON ^
          -DTFLITE_ENABLE_GPU=OFF ^
          -DTFLITE_ENABLE_NNAPI=OFF ^
          -DTFLITE_ENABLE_XNNPACK=ON ^
          -DTFLITE_ENABLE_RUY=ON
        
    - name: Build TFLite C Library
      shell: cmd
      run: |
        cd tensorflow\tensorflow\lite\c\build
        cmake --build . --config Release
        
    - name: Collect Artifacts
      shell: cmd
      run: |
        mkdir output
        
        echo Looking for built files...
        
        rem Copy DLL and LIB files from build directory
        if exist tensorflow\tensorflow\lite\c\build\*.dll (
            copy tensorflow\tensorflow\lite\c\build\*.dll output\
        )
        if exist tensorflow\tensorflow\lite\c\build\*.lib (
            copy tensorflow\tensorflow\lite\c\build\*.lib output\
        )
        
        rem Check Release subdirectory
        if exist tensorflow\tensorflow\lite\c\build\Release\*.dll (
            copy tensorflow\tensorflow\lite\c\build\Release\*.dll output\
        )
        if exist tensorflow\tensorflow\lite\c\build\Release\*.lib (
            copy tensorflow\tensorflow\lite\c\build\Release\*.lib output\
        )
        
        rem Copy headers
        mkdir output\include
        xcopy /E /I tensorflow\tensorflow\lite\c\*.h output\include\
        
        rem Show output
        echo Output directory contents:
        dir output
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tflite-dll
        path: output/*
