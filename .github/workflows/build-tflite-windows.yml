name: Build TFLite AAR and DLL

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  # -------------------------------------------
  #  ANDROID AAR BUILD (Linux + Bazel)
  # -------------------------------------------
  build-aar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y python3 zip unzip build-essential openjdk-17-jdk

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Install Android NDK and Build Tools
        run: |
          sdkmanager --install "ndk;25.2.9519653"
          sdkmanager --install "build-tools;34.0.0"
          sdkmanager --install "platforms;android-34"

      - name: Set Android Environment Variables
        run: |
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV

      - name: Install Bazelisk
        run: |
          sudo wget https://github.com/bazelbuild/bazelisk/releases/latest/download/bazelisk-linux-amd64 -O /usr/local/bin/bazel
          sudo chmod +x /usr/local/bin/bazel

      - name: Clone TensorFlow
        run: git clone --depth 1 https://github.com/tensorflow/tensorflow.git

      - name: Configure Bazel for Android
        run: |
          cd tensorflow
          cat > .bazelrc.user << EOF
          build --action_env ANDROID_HOME=$ANDROID_HOME
          build --action_env ANDROID_NDK_HOME=$ANDROID_NDK_HOME
          EOF

      - name: Build TFLite AAR (CPU)
        run: |
          cd tensorflow
          bazel build -c opt \
            --fat_apk_cpu=armeabi-v7a,arm64-v8a,x86,x86_64 \
            //tensorflow/lite/java:tensorflow-lite

      - name: Build TFLite GPU AAR
        run: |
          cd tensorflow
          bazel build -c opt \
            --fat_apk_cpu=armeabi-v7a,arm64-v8a,x86,x86_64 \
            //tensorflow/lite/java:tensorflow-lite-gpu

      - name: Build Select TF Ops AAR
        run: |
          cd tensorflow
          bazel build -c opt \
            --fat_apk_cpu=armeabi-v7a,arm64-v8a,x86,x86_64 \
            //tensorflow/lite/java:tensorflow-lite-select-tf-ops

      - name: Upload AAR Files
        uses: actions/upload-artifact@v4
        with:
          name: tflite-aar
          path: tensorflow/bazel-bin/tensorflow/lite/java/*.aar


  # -------------------------------------------
  #  WINDOWS DLL BUILD (MinGW + CMake + Ninja)
  # -------------------------------------------
  build-dll:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          choco install ninja -y
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=1' -y
          choco install mingw -y

      - name: Clone TensorFlow
        run: git clone --depth 1 https://github.com/tensorflow/tensorflow.git

      - name: Create build directory
        run: mkdir tensorflow\tensorflow\lite\build

      - name: Configure with CMake
        shell: cmd
        run: |
          cd tensorflow\tensorflow\lite\build
          cmake .. ^
            -DCMAKE_SYSTEM_NAME=Windows ^
            -DCMAKE_C_COMPILER=C:/ProgramData/chocolatey/lib/mingw/tools/install/mingw64/bin/gcc.exe ^
            -DCMAKE_CXX_COMPILER=C:/ProgramData/chocolatey/lib/mingw/tools/install/mingw64/bin/g++.exe ^
            -DTFLITE_ENABLE_XNNPACK=ON ^
            -DBUILD_SHARED_LIBS=ON ^
            -DCMAKE_BUILD_TYPE=Release ^
            -G Ninja

      - name: Build TFLite DLL
        shell: cmd
        run: |
          cd tensorflow\tensorflow\lite\build
          ninja tensorflowlite_c

      - name: Find and List Built Files
        shell: pwsh
        run: |
          Get-ChildItem -Path tensorflow\tensorflow\lite\build -Recurse -Include *.dll,*.lib,*.a | ForEach-Object { $_.FullName }

      - name: Upload DLL
        uses: actions/upload-artifact@v4
        with:
          name: tflite-windows-dll
          path: |
            tensorflow/tensorflow/lite/build/**/*.dll
            tensorflow/tensorflow/lite/build/**/*.lib
            tensorflow/tensorflow/lite/build/**/*.a
